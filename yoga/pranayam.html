<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Pranayam</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <script src="https://code.jquery.com/jquery-3.7.0.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g="
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"
            integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin="anonymous"></script>

</head>
<body>
<h1>Pranayam</h1>

<table class="table-bordered">
    <tr>
        <td colspan="2">
            <div style="display: flex; flex-direction: row; justify-items: center; align-items: center">
                <button type="button" class="btn btn-primary" style="margin: 5px 5px 5px 5px;"
                    onclick="start();">
                    <i class="bi-play"></i>
                    Start
                </button>
                <!-- button type="button" class="btn btn-primary" style="margin: 5px 5px 5px 5px;">
                    <i class="bi-pause"></i>
                    Pause
                </button>
                <button type="button" class="btn btn-primary" style="margin: 5px 5px 5px 5px;">
                    <i class="bi-play"></i>
                    Resume
                </button -->
            </div>
        </td>
    </tr>
    <tr>
        <td>
            <table class="table-bordered">
                <tbody id="steps-tbody">

                </tbody>
            </table>

        </td>
        <td>
            <div id="player"></div>
        </td>
    </tr>
</table>

<script>
    var player;

    // Audio Context - make sure it gets initialized on a user interaction
    var audioContext = null

    // Speech Synthesis
    const synth = window.speechSynthesis

    var currentStep = 0
    var steps = [
        // Step Name, Start Time, Duration (secs)
        //["Bhastrika", "05:39", "5"],
        //["Kapalbhati", "09:40", "5"],
        ["Bhastrika", "05:39", "60"],
        ["Kapalbhati", "09:40", "300"],
        ["Brahya", "23:11", "60"],
        //["Agnisaar Kriya", "25:01"],
        ["Anulomvilom", "25:20", "300"],
        ["Bhramari", "42:34", "60"],
        ["Udgith", "44:11", "60"],
        ["Om Dhyaan", "45:00", "60"],
        //["Ujjayi Pranayama", "46:40"],
        //["Shitri Pranayama", "48:48"],
        //["Sitkari Pranayama", "49:40"]
        ];

    //======================================================================================================================
    $(document).ready(function () {
        loadYoutubeApiScript();
        loadSteps();
    });

    //======================================================================================================================
    // This function creates an <iframe> (and YouTube player)
    //    after the API code downloads.
    function loadYoutubeApiScript() {
        // This code loads the IFrame Player API code asynchronously.
        var tag = document.createElement('script');

        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }

    //======================================================================================================================
    // This is called by YouTube API initialization code.
    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '390',
            width: '640',
            videoId: 'B8iFR13aeKs',
            playerVars: {
                'playsinline': 1
            },
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
            }
        });
    }

    //======================================================================================================================
    // 4. The API will call this function when the video player is ready.
    function onPlayerReady(event) {
        //event.target.seekTo(3057)
       //event.target.playVideo();
    }

    //======================================================================================================================
    // 5. The API calls this function when the player's state changes.
    //    The function indicates that when playing a video (state=1),
    //    the player should play for six seconds and then stop.
    var done = false;

    function onPlayerStateChange(event) {
        changeBorderColor(event.data)
    }

    //======================================================================================================================
    function changeBorderColor(playerStatus) {
        var color;
        if (playerStatus == -1) {
            color = "#37474F"; // unstarted = gray
        } else if (playerStatus == 0) {
            color = "#FFFF00"; // ended = yellow
        } else if (playerStatus == 1) {
            color = "#33691E"; // playing = green
        } else if (playerStatus == 2) {
            color = "#DD2C00"; // paused = red
        } else if (playerStatus == 3) {
            color = "#AA00FF"; // buffering = purple
        } else if (playerStatus == 5) {
            color = "#FF6DOO"; // video cued = orange
        }
        if (color) {
            document.getElementById('player').style.borderColor = color;
        }
    }

    //======================================================================================================================
    function loadSteps() {

        // Add a TR element for each step
        $.each(steps, function (index, value) {
            addStepRow(index, value[0], value[1], value[2]);
        });
    }

    //======================================================================================================================
    function addStepRow(stepNum, stepName, stepTime, duration) {
        // Convert duration to minutes and seconds. Example: 90 secs = 1:30, 65 secs = 1:05
        let durationMinutes = Math.floor(duration / 60);
        let durationSeconds = duration % 60;
        // Add leading zero if seconds is less than 10
        if (durationSeconds < 10) {
            durationSeconds = "0" + durationSeconds;
        }
        durationStr = durationMinutes + ":" + durationSeconds;

        $("#steps-tbody").append("<tr><td>" + stepName + "</td><td>" + durationStr + "</td></tr>");
        $("#steps-tbody").append(`<tr><td colspan='2'><div class='progress'> <div class='progress-bar' id='progress-bar-${stepNum}' role='progressbar' style='width: 0%' aria-valuenow='25' aria-valuemin='0' aria-valuemax='100'></div> </div></td></tr>`);
    }

    //======================================================================================================================
    function start() {
        initializeAudioContexts()
        // Start a timer to update progress bar every second
        setInterval(function () {
            // Get the current time in seconds
            let currentTime = player.getCurrentTime()
            // Get the current step
            let step = steps[currentStep]
            // Get the start time of the current step in seconds
            let minSecsStr = step[1]
            let minSecs = minSecsStr.split(":");
            let secs = parseInt(minSecs[0]) * 60 + parseInt(minSecs[1])
            // Calculate the percentage of the video that has been played
            let percentage = ((currentTime - secs) / step[2]) * 100
            // Update the progress bar
            $("#progress-bar-" + currentStep).css("width", percentage + "%")
        }, 1000)
        runStep(0)
    }

    //======================================================================================================================
    function runStep(stepNum) {
        if (stepNum >= steps.length) {
            return
        }
        step = steps[stepNum]
        minSecsStr = step[1]
        // Convert minutes and seconds to seconds. Example: 1:30 = 90 secs, 1:05 = 65 secs
        let minSecs = minSecsStr.split(":");
        let secs = parseInt(minSecs[0]) * 60 + parseInt(minSecs[1])

        player.seekTo(secs)
        player.playVideo()
        currentStep = stepNum
        setTimeout(function () {
            // Play a beep sound at the end of the step
            playBeep(440, 1000, 'sine')
            // Mark the progress bar complete
            $("#progress-bar-" + stepNum).css("width", "100%")

            runStep(stepNum + 1)
        }, parseInt(step[2]) * 1000)
    }

    //======================================================================================================================
    // A U D I O    B E E P
    //======================================================================================================================


    //======================================================================================================================
    // Play a beep
    // Usage: playBeep(440, 1000, 'sine')
    function playBeep(frequency, duration, waveform) {
        const oscillator = audioContext.createOscillator();
        oscillator.frequency.value = frequency; // A4
        oscillator.type = waveform; // Sine wave
        //oscillator.gain.value = 0.5; // Half volume
        oscillator.connect(audioContext.destination); // Connect to speakers
        oscillator.start(); // Start playing the tone
        setTimeout(() => {
          oscillator.stop(); // Stop playing the tone after 1 second
        }, duration);
    }

    //======================================================================================================================
    // On iOS, audio context must be initialized when the user clicks on a button. Otherwise audio will not work.
    function initializeAudioContexts() {
        if (audioContext == null) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            unlockAudioContext(audioContext);
            audioContext.resume()
        }
    }

    //======================================================================================================================
    function unlockAudioContext(audioCtx) {
       if (audioCtx.state !== 'suspended') return;
       const b = document.body;
       const events = ['touchstart', 'touchend', 'mousedown', 'keydown'];
       events.forEach(e => b.addEventListener(e, unlock, false));

       function unlock() {
           audioCtx.resume().then(clean);
       }

       function clean() {
           events.forEach(e => b.removeEventListener(e, unlock));
       }
    }

</script>
</body>
</html>